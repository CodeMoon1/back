package com.oceanodosdados.service;

import br.com.efi.efisdk.EfiPay;
import br.com.efi.efisdk.exceptions.EfiPayException;
import com.oceanodosdados.config.Credentials;
import com.oceanodosdados.domain.PixCharge;
import com.oceanodosdados.enums.StatusEfi;
import com.oceanodosdados.records.apiPix.PixRequest;
import com.oceanodosdados.repository.PixRepository;
import jakarta.transaction.Transactional;
import org.json.JSONObject;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Service;

import javax.imageio.ImageIO;
import java.io.ByteArrayInputStream;
import java.io.File;
import java.util.Base64;
import java.util.HashMap;

@Service
public class PixService {

    // 1. Inicializa o logger para esta classe.
    private static final Logger log = LoggerFactory.getLogger(PixService.class);

    private final JSONObject options;
    private final String keyPix;
    private final EfiPay efi;
    private final PixRepository pixRepository;

    public PixService(final Credentials credentials, @Value("${chave.pix}") String keyPix, PixRepository pixRepository) {
        this.pixRepository = pixRepository;
        log.info("Iniciando o PixService...");
        try {
            String certPath = credentials.certificate();
            File certFile = new File(certPath);

            if (!certFile.exists() || !certFile.canRead()) {
                log.error("Falha crítica: Certificado da Efí não encontrado ou sem permissão de leitura no caminho: {}", certPath);
                throw new RuntimeException("Certificado não encontrado ou sem permissão em: " + certPath);
            }
            log.info("Certificado da Efí carregado com sucesso de: {}", certPath);

            this.options = new JSONObject();
            this.options.put("client_id", credentials.clientId());
            this.options.put("client_secret", credentials.clientSecret());
            this.options.put("certificate", certPath);
            this.options.put("sandbox", credentials.sandbox());
            this.options.put("debug", credentials.debug()); // Manter debug da Efí ativo é uma boa ideia

            this.keyPix = keyPix;
            this.efi = new EfiPay(options);
            log.info("PixService inicializado e cliente EfiPay pronto. Ambiente sandbox: {}", credentials.sandbox());
        } catch (Exception e) {
            log.error("Erro fatal durante a inicialização do PixService. Causa: {}", e.getMessage(), e);
            throw new RuntimeException("Erro na inicialização do PixService: " + e.getMessage(), e);
        }
    }

    public JSONObject criaPix(PixRequest pixRequest) {
        log.info("Iniciando criação de cobrança PIX imediata para o CPF: {}", pixRequest.cpf());

        JSONObject body = new JSONObject();
        try {
            body.put("calendario", new JSONObject().put("expiracao", 3600));
            body.put("devedor", new JSONObject().put("cpf", pixRequest.cpf()).put("nome", pixRequest.nome()));
            body.put("valor", new JSONObject().put("original", "1.00")); // Valor fixo para teste
            body.put("chave", keyPix);
            body.put("solicitacaoPagador", "Serviço realizado.");

            // 2. Log antes da chamada de rede.
            log.info("Enviando requisição para a API Efí (pixCreateImmediateCharge)...");
            log.debug("Corpo da requisição (JSON): {}", body.toString());

            JSONObject response = efi.call("pixCreateImmediateCharge", new HashMap<>(), body);

            // 3. Log de sucesso.
            log.info("Cobrança PIX criada com sucesso na Efí. TxID: {}", response.optString("txid", "N/A"));
            log.debug("Resposta completa da API: {}", response.toString());

            processAndSave(response);
            return response;
        } catch (EfiPayException e) {
            // 4. Log detalhado para exceções da API Efí.
            log.error("Erro da API Efí ao criar cobrança PIX. Código: {}, Erro: {}, Descrição: {}", e.getCode(), e.getError(), e.getErrorDescription(), e);
            throw new RuntimeException("Erro na API Efí: " + e.getErrorDescription());
        } catch (Exception e) {
            // 5. Log detalhado para exceções genéricas (aqui que o "Unexpected end of file" deve ser capturado).
            log.error("Erro técnico inesperado ao criar cobrança PIX. Classe da exceção: {}", e.getClass().getName(), e);
            throw new RuntimeException("Erro técnico: " + e.getMessage(), e);
        }
    }

    @Transactional
    private void processAndSave(JSONObject response) throws Exception {
        log.info("Processando e salvando dados da cobrança com TxID: {}", response.getString("txid"));
        // ... (seu código de processamento continua igual)
        String txid = response.getString("txid");
        String pixCopiaECola = response.getString("pixCopiaECola");
        StatusEfi status = StatusEfi.valueOf(response.getString("status"));
        String valor = response.getJSONObject("valor").getString("original");
        String data = response.getJSONObject("calendario").getString("criacao");
        String cpf = response.getJSONObject("devedor").getString("cpf");
        Integer locId = response.getJSONObject("loc").getInt("id");
        
        PixCharge payment = new PixCharge(txid, valor, status, pixCopiaECola, locId, data, cpf);

        pixRepository.save(payment);
        log.info("Cobrança com TxID: {} salva com sucesso no banco de dados.", txid);
    }

    public JSONObject getPixQrCode(int id) {
        log.info("Iniciando geração de QR Code para a localização PIX de ID: {}", id);
        HashMap<String, String> params = new HashMap<>();
        params.put("id", String.valueOf(id));
        try {
            log.info("Enviando requisição para a API Efí (pixGenerateQRCode)...");
            JSONObject response = efi.call("pixGenerateQRCode", params, new JSONObject());
            log.info("QR Code gerado com sucesso pela API Efí.");

            // ... (seu código de processamento de imagem continua igual)
            String base64Image = (String) response.get("imagemQrcode");
            byte[] imageBytes = Base64.getDecoder().decode(base64Image.split(",")[1]);
            File outputfile = new File("qrCodeImage.png");
            ImageIO.write(ImageIO.read(new ByteArrayInputStream(imageBytes)), "png", outputfile);
            log.info("Imagem do QR Code salva em: {}", outputfile.getAbsolutePath());
            return response;
        } catch (EfiPayException e) {
            log.error("Erro da API Efí ao gerar QR Code. Código: {}, Erro: {}, Descrição: {}", e.getCode(), e.getError(), e.getErrorDescription(), e);
            throw new RuntimeException(e.getErrorDescription());
        } catch (Exception e) {
            log.error("Erro técnico inesperado ao gerar QR Code. Classe da exceção: {}", e.getClass().getName(), e);
            throw new RuntimeException(e.getMessage(), e);
        }
    }
}
